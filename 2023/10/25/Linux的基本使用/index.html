<!DOCTYPE html>
<html lang="zh-CN,zh-TW,en,default">
<head>
  <meta charset="UTF-8">




<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

  <meta name="author" content="Yali.Wang">


  <meta name="subtitle" content="深情喂鸭梨">


  <meta name="description" content="一个运维工程师，分享相关技术以及最近在读的书本">



<title>Linux的基本使用 | Yali&#39;s Blog</title>



<link rel="icon" href="/favicon.png">



<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/nprogress/nprogress.css">



<script src="/lib/jquery.min.js"></script>


<script src="/lib/iconify-icon.min.js"></script>


<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
<script>
  tailwind.config = {
    darkMode: "class",
  };
</script>


<script src="/lib/nprogress/nprogress.js"></script>

<script>
  $(document).ready(() => {
    NProgress.configure({
      showSpinner: false,
    });
    NProgress.start();
    $("#nprogress .bar").css({
      background: "#de7441",
    });
    $("#nprogress .peg").css({
      "box-shadow": "0 0 2px #de7441, 0 0 4px #de7441",
    });
    $("#nprogress .spinner-icon").css({
      "border-top-color": "#de7441",
      "border-left-color": "#de7441",
    });
    setTimeout(function () {
      NProgress.done();
      $(".fade").removeClass("out");
    }, 800);
  });
</script>

<script>
  (function () {
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const setting = localStorage.getItem("hexo-color-scheme") || "auto";
    if (setting === "dark" || (prefersDark && setting !== "light"))
      document.documentElement.classList.toggle("dark", true);
    let isDark = document.documentElement.classList.contains("dark");
  })();

  $(document).ready(function () {
    // init icon
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const isDark = document.documentElement.classList.contains("dark");
    $("#theme-icon").attr("icon", isDark ? "ri:moon-line" : "ri:sun-line");

    function toggleGiscusTheme() {
      const isDark = document.documentElement.classList.contains("dark");
      const giscusFrame = document.querySelector("iframe.giscus-frame");
      if (giscusFrame) {
        giscusFrame.contentWindow.postMessage(
          {
            giscus: {
              setConfig: {
                theme: isDark ? "dark" : "light",
              },
            },
          },
          "https://giscus.app"
        );
      }
    }


    // toggle dark mode
    function toggleDark() {
      let isDark = document.documentElement.classList.contains("dark");
      const setting = localStorage.getItem("hexo-color-scheme") || "auto";
      isDark = !isDark;
      document.documentElement.classList.toggle("dark", isDark);
      $("#theme-icon").attr("icon", isDark ? "ri:moon-line" : "ri:sun-line");
      if (prefersDark === isDark) {
        localStorage.setItem("hexo-color-scheme", "auto");
      } else {
        localStorage.setItem("hexo-color-scheme", isDark ? "dark" : "light");
      }
      toggleGiscusTheme();
    }
    $("#toggle-dark").click(toggleDark);

    // listen dark mode change
    window
      .matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", (e) => {
        const setting = localStorage.getItem("hexo-color-scheme") || "auto";
        if (setting === "auto") {
          document.documentElement.classList.toggle("dark", e.matches);
          $("#theme-icon").attr(
            "icon",
            e.matches ? "ri:moon-line" : "ri:sun-line"
          );
          toggleGiscusTheme();
        }
      });
  });
</script>




<meta name="generator" content="Hexo 6.3.0"></head>
<body class="font-sans bg-white dark:bg-zinc-900 text-gray-700 dark:text-gray-200 relative">
  <header class="fixed w-full px-5 py-1 z-10 backdrop-blur-xl backdrop-saturate-150 border-b border-black/5">
  <div class="max-auto">
    <nav class="flex items-center text-base">
      <a href="/" class="group">
        <h2 class="font-medium tracking-tighterp text-l p-2">
          <img class="w-5 mr-2 inline-block transition-transform group-hover:rotate-[30deg]" id="logo" src="/images/logo.svg" alt="Yali's Blog" />
          Yali&#39;s Blog
        </h2>
      </a>
      <div id="header-title" class="opacity-0 md:ml-2 md:mt-[0.1rem] text-xs font-medium whitespace-nowrap overflow-hidden overflow-ellipsis">
        Linux的基本使用
      </div>
      <div class="flex-1"></div>
      <div class="flex items-center gap-3">
        
          <a class="hidden sm:flex" href="/archives">首页</a>
        
          <a class="hidden sm:flex" href="/category">分类</a>
        
          <a class="hidden sm:flex" href="/tag">标签</a>
        
        
          
            <a class="w-5 h-5 hidden sm:flex" title="Github" target="_blank" rel="noopener" href="https://github.com/Yali7">
              <iconify-icon width="20" icon="ri:github-line"></iconify-icon>
            </a>
          
        
<!--        <a class="w-5 h-5 hidden sm:flex" title="Github" href="rss2.xml">  -->
<!--          <iconify-icon width="20" icon="ri:rss-line"></iconify-icon>  -->
        </a>
        <a class="w-5 h-5" title="toggle theme" id="toggle-dark">
          <iconify-icon width="20" icon="" id="theme-icon"></iconify-icon>
        </a>
      </div>
      <div class="flex items-center justify-center gap-3 ml-3 sm:hidden">
        <span class="w-5 h-5" aria-hidden="true" role="img" id="open-menu">
          <iconify-icon width="20" icon="carbon:menu" ></iconify-icon>
        </span>
        <span class="w-5 h-5 hidden" aria-hidden="true" role="img" id="close-menu">
          <iconify-icon  width="20" icon="carbon:close" ></iconify-icon>
        </span>
      </div>
    </nav>
  </div>
</header>
<div id="menu-panel" class="h-0 overflow-hidden sm:hidden fixed left-0 right-0 top-12 bottom-0 z-10">
  <div id="menu-content" class="relative z-20 bg-white/80 px-6 sm:px-8 py-2 backdrop-blur-xl -translate-y-full transition-transform duration-300">
    <ul class="nav flex flex-col sm:flex-row text-sm font-medium">
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/archives" class="flex h-12 sm:h-auto items-center">首页</a>
        </li>
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/category" class="flex h-12 sm:h-auto items-center">分类</a>
        </li>
      
        <li class="nav-portfolio sm:mx-2 border-b sm:border-0 border-black/5 last:border-0 hover:text-main">
          <a href="/tag" class="flex h-12 sm:h-auto items-center">标签</a>
        </li>
      
    </ul>
  </div>
  <div class="mask bg-black/20 absolute inset-0"></div>
</div>

  <main class="pt-14">
    <!-- css -->

<link rel="stylesheet" href="/lib/fancybox/fancybox.min.css">


<link rel="stylesheet" href="/lib/tocbot/tocbot.min.css">

<!-- toc -->

  <!-- tocbot -->
<nav class="post-toc toc text-sm w-48 relative top-32 right-0 opacity-70 hidden lg:block" style="position: fixed !important;"></nav>


<section class="px-6 max-w-prose mx-auto md:px-0">
  <!-- header -->
  <header class="overflow-hidden pt-6 pb-6 md:pt-12">
    <div class="pt-4 md:pt-6">
      <h1 id="article-title" class="text-[2rem] font-bold leading-snug mb-4 md:mb-6 md:text-[2.6rem]">
        Linux的基本使用
      </h1>
      <div>
        <section class="flex items-center gap-3 text-sm">
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="carbon-calendar" ></iconify-icon>
            <time>2023-10-25</time>
          </span>
          <span class="text-gray-400">·</span>
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="ic:round-access-alarm" ></iconify-icon>
            <span>53 min</span>
          </span>
          <span class="text-gray-400">·</span>
          <span class="flex items-center gap-1">
            <iconify-icon width="18" icon="icon-park-outline:font-search" ></iconify-icon>
            <span>11.6k words</span>
          </span>
          
            <span class="text-gray-400">·</span>
            <span class="flex items-center gap-1">
              <iconify-icon width="16" icon="icon-park-outline:box" class="mr-2"></iconify-icon>
              <a class="article-category-link" href="/categories/docker/">docker</a>/<a class="article-category-link" href="/categories/linux/">linux</a>/<a class="article-category-link" href="/categories/linux/nginx/">nginx</a>/<a class="article-category-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a>
            </span>
          
        </section>
      </div>
    </div>
  </header>
  <!-- content -->
  <article class="post-content prose m-auto slide-enter-content dark:prose-invert">
    <blockquote><p>Do not just seek happiness for yourself. Seek happiness for all. Through kindness. Through mercy.</p>
<footer><strong>David Levithan</strong><cite>Wide Awake</cite></footer></blockquote>

<h2 id="5-1、Pod介绍"><a href="#5-1、Pod介绍" class="headerlink" title="5.1、Pod介绍"></a>5.1、Pod介绍</h2><h3 id="5-1-1-Pod结构"><a href="#5-1-1-Pod结构" class="headerlink" title="5.1.1 Pod结构"></a>5.1.1 Pod结构</h3><p><img src="https://note.youdao.com/yws/res/44216/9583D6BEAED040D79B4AD7A8D7F2A12A" alt="image"></p>
<p>每个Pod中都可以包含一个或者多个容器，这些容器可以分为两类：</p>
<ul>
<li>用户程序所在的容器，数量可多可少</li>
<li>Pause容器，这是每个Pod都会有的一个根容器，它的作用主要有两个。<ul>
<li>可以以根容器为依据，评估整个Pod的健康状态</li>
<li>可以在根容器上设置IP地址，其他容器都共享这个IP，从而实现Pod内部的网络通信<blockquote>
<p>这里是pod内部的通讯，Pod的之间的通讯采用虚拟二层网络技术，当前环境用的是Flannel</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="5-1-2-Pod定义"><a href="#5-1-2-Pod定义" class="headerlink" title="5.1.2 Pod定义"></a>5.1.2 Pod定义</h3><p>下面是Pod的资源清单<br><img src="https://note.youdao.com/yws/res/44217/3C671FC454BD4041AEC3CC86593897AF" alt="image"><br><img src="https://note.youdao.com/yws/res/44221/A718D658AEDB4AA2AE00B7018F24E7FF" alt="image"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以通过kubectl explain pod 来查看每种资源的可配置项</span></span><br><span class="line"><span class="comment"># kubectl explain 资源类型      查看某种资源可以配置的一级属性</span></span><br><span class="line"><span class="comment"># kubectl explain 资源类型.属性 查看属性的子属性</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl explain pod</span></span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     Pod is a collection of containers that can run on a host. This resource is</span><br><span class="line">     created by clients and scheduled onto hosts.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   apiVersion	&lt;string&gt;</span><br><span class="line">     APIVersion defines the versioned schema of this representation of an</span><br><span class="line">     object. Servers should convert recognized schemas to the latest internal</span><br><span class="line">     value, and may reject unrecognized values. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="comment">#resources</span></span><br><span class="line"></span><br><span class="line">   kind	&lt;string&gt;</span><br><span class="line">     Kind is a string value representing the REST resource this object</span><br><span class="line">     represents. Servers may infer this from the endpoint the client submits</span><br><span class="line">     requests to. Cannot be updated. In CamelCase. More info:</span><br><span class="line">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md<span class="comment">#types-kinds</span></span><br><span class="line"></span><br><span class="line">   metadata	&lt;Object&gt;</span><br><span class="line">     Standard object<span class="string">&#x27;s metadata. More info:</span></span><br><span class="line"><span class="string">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   spec	&lt;Object&gt;</span></span><br><span class="line"><span class="string">     Specification of the desired behavior of the pod. More info:</span></span><br><span class="line"><span class="string">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   status	&lt;Object&gt;</span></span><br><span class="line"><span class="string">     Most recently observed status of the pod. This data may not be up to date.</span></span><br><span class="line"><span class="string">     Populated by the system. Read-only. More info:</span></span><br><span class="line"><span class="string">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 查看属性的子属性 </span></span><br><span class="line"><span class="string">[root@master ~]# kubectl explain pod.kind</span></span><br><span class="line"><span class="string">KIND:     Pod</span></span><br><span class="line"><span class="string">VERSION:  v1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">FIELD:    kind &lt;string&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">DESCRIPTION:</span></span><br><span class="line"><span class="string">     Kind is a string value representing the REST resource this object</span></span><br><span class="line"><span class="string">     represents. Servers may infer this from the endpoint the client submits</span></span><br><span class="line"><span class="string">     requests to. Cannot be updated. In CamelCase. More info:</span></span><br><span class="line"><span class="string">     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds</span></span><br><span class="line"><span class="string">[root@master ~]#</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>在kubernetes中基本所有资源的一级属性都是一样的，主要包括5部分：</p>
<ul>
<li>apiVersion  &lt;string&gt;  版本，由kubernetes内部定义，版本号必须可以用kubectl api-versions查询到</li>
<li>kind  类型，由kubernetes内部定义，版本号必须可以用kubectl api-resources查询到</li>
<li>metadata  元数据，主要是资源标识和说明，常用的有name、namespace、labels等</li>
<li>spec  描述，这是配置中最重要的一部分，里面是对各种资源配置的详细描述</li>
<li>status    状态描述，里面的内容不需要定义，由kubernetes自动生成</li>
</ul>
<p>在上面的属性中，spec是接下来研究的重点，继续看下他的常见子属性：</p>
<ul>
<li>containers  容器列表，用于定义容器的详细信息</li>
<li>nodeName      根据nodeName的值将pod调度到指定的Node节点上</li>
<li>nodeSelector  根据nodeSelector中定义的信息选择将该pod调度到包含这些labe的Node上</li>
<li>hostNetwork   存储卷，用于定义pod上面挂载的存储信息</li>
<li>restarPolicy  重启策略，表示pod在遇到故障的时候的处理策略</li>
</ul>
<h2 id="5-2-Pod配置"><a href="#5-2-Pod配置" class="headerlink" title="5.2 Pod配置"></a>5.2 Pod配置</h2><p>本小节主要来研究<code>pod.spec.containers</code>属性，这也是pod配置中最为关键的一项配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl explain pod.spec.containers</span></span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">RESOURCE: containers &lt;[]Object&gt;     <span class="comment"># 数组，代表可以有多个容器</span></span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     List of containers belonging to the pod. Containers cannot currently be</span><br><span class="line">     added or removed. There must be at least one container <span class="keyword">in</span> a Pod. Cannot be</span><br><span class="line">     updated.</span><br><span class="line"></span><br><span class="line">     A single application container that you want to run within a pod.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">    name    <span class="comment">#容器名称</span></span><br><span class="line">    image   <span class="comment"># 容器需要的镜像地址</span></span><br><span class="line">    imagePullPolicy <span class="comment"># 镜像拉取策略</span></span><br><span class="line">    <span class="built_in">command</span> <span class="comment"># 容器的启动命令列表，如不指定，使用打包时使用的启动命令</span></span><br><span class="line">    args    <span class="comment"># 容器环境变量的配置</span></span><br><span class="line">    ports   <span class="comment"># 容器需要暴露的端口号列表</span></span><br><span class="line">    resources   <span class="comment"># 资源限制和资源请求的设置</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-2-1-基本配置"><a href="#5-2-1-基本配置" class="headerlink" title="5.2.1 基本配置"></a>5.2.1 基本配置</h3><p>创建pod-base.yaml文件，内容如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-base</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">yali</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br></pre></td></tr></table></figure>

<p>启动pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod.base.yaml</span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod -n dev</span></span><br><span class="line">NAME       READY   STATUS             RESTARTS   AGE</span><br><span class="line">pod-base   1/2     CrashLoopBackOff   6          7m55s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod状态</span></span><br><span class="line"><span class="comment"># READY 1/2 ：表示当前Pod中有2个容器，其中一个准备就绪，1个未就绪</span></span><br><span class="line"><span class="comment"># RESTARTS：重启次数，因为有1个容器故障了，pod一直在重启试图恢复它</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以通过describe查看内部的详情</span></span><br><span class="line"><span class="comment"># 此时已经运行起来了一个级别的pod，虽然它暂时有问题</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl describe  pod pod-base -n dev</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                     From               Message</span><br><span class="line">  ----     ------     ----                    ----               -------</span><br><span class="line">  Normal   Scheduled  9m22s                   default-scheduler  Successfully assigned dev/pod-base to node2</span><br><span class="line">  Normal   Pulling    9m22s                   kubelet            Pulling image <span class="string">&quot;nginx:1.17.1&quot;</span></span><br><span class="line">  Normal   Pulled     8m31s                   kubelet            Successfully pulled image <span class="string">&quot;nginx:1.17.1&quot;</span> <span class="keyword">in</span> 50.711467933s</span><br><span class="line">  Normal   Created    8m31s                   kubelet            Created container nginx</span><br><span class="line">  Normal   Started    8m31s                   kubelet            Started container nginx</span><br><span class="line">  Normal   Pulling    8m31s                   kubelet            Pulling image <span class="string">&quot;busybox:1.30&quot;</span></span><br><span class="line">  Normal   Pulled     8m14s                   kubelet            Successfully pulled image <span class="string">&quot;busybox:1.30&quot;</span> <span class="keyword">in</span> 17.334324187s</span><br><span class="line">  Normal   Created    7m32s (x4 over 8m14s)   kubelet            Created container busybox</span><br><span class="line">  Normal   Started    7m32s (x4 over 8m13s)   kubelet            Started container busybox</span><br><span class="line">  Normal   Pulled     6m48s (x4 over 8m13s)   kubelet            Container image <span class="string">&quot;busybox:1.30&quot;</span> already present on machine</span><br><span class="line">  Warning  BackOff    4m16s (x20 over 8m12s)  kubelet            Back-off restarting failed container</span><br><span class="line">[root@master ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-2-镜像拉取"><a href="#5-2-2-镜像拉取" class="headerlink" title="5.2.2 镜像拉取"></a>5.2.2 镜像拉取</h3><p>创建pod-imagepullpolicy.yaml文件，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-imagepullpolicy</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">Always</span>   <span class="comment"># 用于设置镜像拉取策略</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br></pre></td></tr></table></figure>

<p>imagePullPolicy，用于设置镜像拉取策略，kubernetes支持配置三种拉取策略：</p>
<ul>
<li>Always：总是从远程仓库拉取镜像（一直用远程的）</li>
<li>ifNotPresent：本地有则使用本地镜像，没有则从远程仓库拉取</li>
<li>Never：只使用本地镜像，从不去远程仓库拉取，本地没有就报错</li>
</ul>
<blockquote>
<p>默认值说明：<br>- 如果镜像tag为具体版本号，默认策略是：ifNotPresent<br>- 如果镜像tag为：latest（最终版本），默认策略是always</p>
</blockquote>
<h3 id="5-2-3-启动命令"><a href="#5-2-3-启动命令" class="headerlink" title="5.2.3 启动命令"></a>5.2.3 启动命令</h3><ul>
<li>在前面的案例中，一直有一个问题没有解决，就是busybox容器一直没有成功执行，那么到底是什么原因导致这个容器的故障呢？</li>
<li>原来busybox并不是一个程序，而是类似于一个工具类的集合，kubernetes集群启动管理后，它会自动关闭。解决方法就是让其一直在运行，这就用到了command配置。<br><strong>创建pod-command.yaml</strong> 文件，内容如下：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-command</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;touch /tmp/hellp.txt;while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt; sleep 3; done;&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><strong>command，用于在pod中的容器初始化完毕之后运行一个命令</strong></p>
<blockquote>
<p>上面命令意思为：<br>- “&#x2F;bin&#x2F;sh”  使用sh执行命令<br>- “-c” 使用管理员身份运行<br>- touch &#x2F;tmp&#x2F;hello.txt; 创建一个&#x2F;tmp&#x2F;hello.txt 文件<br>- while true;do &#x2F;bin&#x2F;echo $(date +%T) &gt;&gt; &#x2F;tmp&#x2F;hello.txt; sleep 3; done; 每隔3秒向文件中写入当前时间</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编写yaml文件</span></span><br><span class="line">[root@master ~]<span class="comment"># vim pod-command.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-command.yaml </span></span><br><span class="line">pod/pod-command created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod状态</span></span><br><span class="line"><span class="comment"># 此时发现两个pod都正常运行了</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pods -n dev</span></span><br><span class="line">NAME                  READY   STATUS             RESTARTS   AGE</span><br><span class="line">pod-command           2/2     Running            0          2m23s</span><br><span class="line">pod-imagepullpolicy   1/2     CrashLoopBackOff   10         30m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入pod中的busybox容器，查看文件内容</span></span><br><span class="line"><span class="comment"># 进入容器命令：kubectl exec pod名称 -n 命名空间 -it -c 容器名称 /bin/sh 在容器内部执行命令</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl exec pod-command -n dev -it -c busybox /bin/sh</span></span><br><span class="line">kubectl <span class="built_in">exec</span> [POD] [COMMAND] is DEPRECATED and will be removed <span class="keyword">in</span> a future version. Use kubectl <span class="built_in">exec</span> [POD] -- [COMMAND] instead.</span><br><span class="line">/ <span class="comment"># tail -f /tmp/hello.txt </span></span><br><span class="line">05:39:33</span><br><span class="line">05:39:36</span><br><span class="line">05:39:39</span><br><span class="line">05:39:42</span><br><span class="line">05:39:45</span><br><span class="line">05:39:48</span><br><span class="line">05:39:51</span><br><span class="line">05:39:54</span><br><span class="line">05:39:57</span><br><span class="line">05:40:00</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>特别说明：</strong></p>
</blockquote>
<ul>
<li>通过上面发现command已经可以完成启动命令和传递参数的功能，为什么这里还要提供一个args选项，用于传递参数呢？这其实跟docker有关系，kubernetes中的command、args两项其实是实现覆盖Dockerfile中ENTRYPOINT的功能。<ul>
<li>1、如果command和args均没有写，那么用Dockerfile的配置。</li>
<li>2、如果command写了，但args没有写，那么Dockerfile默认的配置会被忽略，执行输入的command</li>
<li>3、如果command没写。但args写了，那么Dockerfile中配置的ENTRYPOINT的命令会被执行，使用当前的args的参数</li>
<li>4、如果command和args都写了，那么Dockerfile的配置被忽略，执行command并追加上args参数。</li>
</ul>
</li>
</ul>
<h3 id="5-2-4-环境变量"><a href="#5-2-4-环境变量" class="headerlink" title="5.2.4 环境变量"></a>5.2.4 环境变量</h3><p>创建pod-env.yaml文件，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadate:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-env</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;while true;do /bin/echo $(date +%T);sleep 60; done;&quot;</span>]</span><br><span class="line">      <span class="attr">env:</span>  <span class="comment"># 设置环境变量列表</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;username&quot;</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;admin&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;password&quot;</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;123456&quot;</span></span><br></pre></td></tr></table></figure>

<p>env，环境变量，用于在pod中的容器设置环境变量。</p>
<pre><code># 创建pod
[root@master ~]# kubectl create -f pod-env.yaml 
pod/pod-env created

# 进入容器
[root@master ~]# kubectl exec pod-env -n dev -c busybox -it /bin/sh
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
/ # echo $username
admin
/ # echo $password
123456
/ # 
</code></pre>
<p>这种方式不是很推荐， 推荐将这些配置单独存储在配置文件中，这种方式将在后面介绍。</p>
<h3 id="5-2-5端口设置"><a href="#5-2-5端口设置" class="headerlink" title="5.2.5端口设置"></a>5.2.5端口设置</h3><p>本小节来介绍容器的端口设置，也就是containers的ports选项<br>首先看一下ports支持的子选项</p>
<pre><code>[root@master ~]# kubectl explain pod.spec.containers.ports
KIND:     Pod
VERSION:  v1
RESOURCE: ports &lt;[]Object&gt;
FIELDS:
   containerPort	&lt;integer&gt; # 容器要监听的端口(0&lt;x&lt;65536)
   hostIP	&lt;string&gt;          # 要将外部端口绑定到的主机IP (一般省略)
   hostPort	&lt;integer&gt;         # 容器要在主机上公开的端口，如果设置，主机上只能运行容器的一个副本 (一般省略)
   name	&lt;string&gt;              # 端口名称，如果指定，必须保证name在pod中是唯一的
   protocol	&lt;string&gt;          # 端口协议。必须是UDP、TCP或SCTP。默认为TCP。
</code></pre>
<p>接下里，编写一个测试案例，创建pod-ports.yaml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-ports</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">      <span class="attr">ports:</span> <span class="comment"># 设置容器暴露的端口列表</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">        <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>

<pre><code>[root@master ~]# kubectl create -f pod-ports.yaml 
pod/pod-ports created

[root@master ~]# kubectl get pod pod-ports -n dev -o wide
NAME        READY   STATUS    RESTARTS   AGE   IP           NODE    NOMINATED NODE   READINESS GATES
pod-ports   1/1     Running   0          56s   10.244.2.7   node2   &lt;none&gt;           &lt;none&gt;

[root@master ~]# kubectl get pod pod-ports -n dev -o yaml
spec:
  containers:
  - image: nginx:1.17.1
    imagePullPolicy: IfNotPresent
    name: nginx
    ports:
    - containerPort: 80
      name: nginx-port
      protocol: TCP

[root@master ~]# kubectl describe pod pod-ports -n dev
Name:         pod-ports
Namespace:    dev
Priority:     0
Node:         node2/192.168.132.142
Start Time:   Tue, 18 Jan 2022 00:41:15 +0800
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;
Status:       Running
IP:           10.244.2.7
IPs:
  IP:  10.244.2.7
Containers:
  nginx:
    Container ID:   docker://a49251d87fa67152375efc3ba9b984e7c7854da40b4368606f8c71dae9547b09
    Image:          nginx:1.17.1
    Image ID:       docker-pullable://nginx@sha256:b4b9b3eee194703fc2fa8afa5b7510c77ae70cfba567af1376a573a967c03dbb
    Port:           80/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Tue, 18 Jan 2022 00:41:16 +0800
    Ready:          True
    Restart Count:  0
    Environment:    &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-hswlf (ro)
</code></pre>
<p>访问容器中的程序需要使用的是<code>podIP:containerPort</code></p>
<h3 id="5-2-6资源配额"><a href="#5-2-6资源配额" class="headerlink" title="5.2.6资源配额"></a>5.2.6资源配额</h3><p>   容器中的程序要运行，肯定是要占用一定资源的，比如cpu和内存等，如果不对某个容器的资源做限制，那么它就可能吃掉大量资源，导致其他容器无法运行。针对这种情况，kubernetes提供了对内存和cpu的资源进行配额的机制，这种机制主要通过resources选择实现，他有两个子选项：</p>
<ul>
<li>limits:用于限制运行时容器的最大占用资源，当容器占用资源超过limits时会被终止，并进行重启</li>
<li>requests:用于设置容器需要的自小资源，如果环境资源不够，容器将无法启动<br>可以通过上面两个选项设置资源的上下限。<br>接下来，编写一个测试案例，创建pod-resources.yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-resources</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="comment"># 资源配置</span></span><br><span class="line">        <span class="attr">limits:</span> <span class="comment"># 限制资源（上限）</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span>  <span class="comment"># CPU限制，单位是core数</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;10Gi&quot;</span> <span class="comment"># 内存限制</span></span><br><span class="line">        <span class="attr">requests:</span> <span class="comment"># 请求资源（下限）</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span> <span class="comment"># CPU限制，单位是core数</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;10Mi&quot;</span> <span class="comment"># 内存限制</span></span><br></pre></td></tr></table></figure>

<p><strong>在这对cpu和memory的单位做一个说明</strong></p>
<ul>
<li>cpu: core数，可以为整数或小数</li>
<li>memory：内存大小，可以使用Gi、Mi、G、M等。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl apply -f pod-resources.yaml </span></span><br><span class="line">pod/pod-resources created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到pod 创建成功</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-resources -n dev</span></span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-resources   1/1     Running   0          58s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看系统内存可以到此，此时的内存最大为3.7G</span></span><br><span class="line">[root@master ~]<span class="comment"># free -h</span></span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           3.7G        1.2G        1.3G         15M        1.2G        2.2G</span><br><span class="line">Swap:            0B          0B          0B</span><br><span class="line">[root@master ~]<span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时，我们将yaml文件中的内存下限改为10Gi,</span></span><br><span class="line"></span><br><span class="line">requests: <span class="comment"># 请求资源（下限）</span></span><br><span class="line">    cpu: <span class="string">&quot;1&quot;</span> <span class="comment"># CPU限制，单位是core数</span></span><br><span class="line">    memory: <span class="string">&quot;10Gi&quot;</span> <span class="comment"># 内存限制</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 再次创建pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl delete -f pod-resources.yaml </span></span><br><span class="line">pod <span class="string">&quot;pod-resources&quot;</span> deleted</span><br><span class="line">[root@master ~]<span class="comment"># kubectl apply -f pod-resources.yaml</span></span><br><span class="line">pod/pod-resources created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时可以看到pod状态为Pending状态。</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-resources -n dev</span></span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-resources   0/1     Pending   0          19s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod详细情况，发现报错内存不足。</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl describe pod pod-resources -n dev</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age    From               Message</span><br><span class="line">  ----     ------            ----   ----               -------</span><br><span class="line">  Warning  FailedScheduling  2m56s  default-scheduler  0/3 nodes are available: 1 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn<span class="string">&#x27;t tolerate, 2 Insufficient memory.</span></span><br><span class="line"><span class="string">  Warning  FailedScheduling  2m56s  default-scheduler  0/3 nodes are available: 1 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn&#x27;</span>t tolerate, 2 Insufficient memory.</span><br></pre></td></tr></table></figure>

<h2 id="5-3-Pod生命周期"><a href="#5-3-Pod生命周期" class="headerlink" title="5.3 Pod生命周期"></a>5.3 Pod生命周期</h2><p><strong>我们一般将pod对象从创建至终的这段时间范围成为pod的生命周期，它主要包含下面的过程：</strong></p>
<ul>
<li>pod创建过程</li>
<li>运行初始化容器(init container)过程</li>
<li>运行主容器(manin cintainer)过程<ul>
<li>容器启动后钩子(post start)、容器终止前钩子(pre stop)</li>
<li>容器的存活性探测(liveness probe)、就绪性探测(readiness probe)</li>
</ul>
</li>
<li>pod终止过程</li>
</ul>
<p><img src="https://note.youdao.com/yws/res/44215/9445A6C03C9B4665ABA27FC7934E7A6F" alt="image"></p>
<p><strong>在整个生命周期中，pod会出现5种状态（相位）：</strong></p>
<ul>
<li>挂起(Pending)：apiserver已经创建了pod资源对象，但它尚未被调度完成仍处于下载镜像的过程中</li>
<li>运行中(Running)：pod已经被调度到节点，并且所有容器都已经被kubelet创建完成。</li>
<li>成功(Succeeded): pod中的所有容器都已经成功被终止并且不会被重启</li>
<li>失败(Failed): 所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非0值的退出状态</li>
<li>未知(Unknow): apiserver无法正常获取到pod对象的状态信息，通常由网络通信失败所导致</li>
</ul>
<h3 id="5-3-1-创建和终止"><a href="#5-3-1-创建和终止" class="headerlink" title="5.3.1 创建和终止"></a>5.3.1 创建和终止</h3><p><strong>pod的创建过程</strong></p>
<ol>
<li>用户通过kubect或其他api客户端提交需要创建的pod信息给apiServer</li>
<li>apiServer开始生产pod对象的信息，并将信息存入etcd，然后返回确认信息到客户端</li>
<li>apiServer开始反映etcd中pod对象的变化，其他组件使用watch机制来跟踪检查apiServer上的变动</li>
<li>scheduler发现有新的pod对象要创建，开始为pod分配主机并将结果信息更新至apiServer</li>
<li>node节点上的kubelet发现有pod调度过来，尝试调用docker启动容器，并将返回结构送至apiServer</li>
<li>apiServer将接受到的pod状态信息存入etcd中。</li>
</ol>
<p><img src="https://note.youdao.com/yws/res/44218/D5E9796FE1AB40179E281B6F0965B9B1" alt="image"></p>
<p><strong>pod的终止过程</strong></p>
<ol>
<li>用户向apiServer发送删除pod对象的命令</li>
<li>apiServer中的pod对象信息会随着时间的推移而更新，在宽限期内（默认30秒），pod被视为dead</li>
<li>将pod标记为terminating状态</li>
<li>kubelet在监控到pod对象转为terminating状态的同时启动pod关闭过程</li>
<li>端点控制器监控到pod对象的关闭行为时将其从所有匹配到此端点的service资源的端点列表中移除</li>
<li>如果当前pod对象定义了preStop钩子处理器，则在其标记为terminating后即会以同步的方式启动执行</li>
<li>pod对象中容器进程收到停止信息</li>
<li>宽限期结束后，若pod中还存在仍在运行的进程，那么pod对象会收到立即终止的信号</li>
<li>kubele请求apiServer将此pod资源的宽限期设置为0从而完成删除操作，此时pod对于用户已不可见</li>
</ol>
<h3 id="5-3-2初始化容器"><a href="#5-3-2初始化容器" class="headerlink" title="5.3.2初始化容器"></a>5.3.2初始化容器</h3><p><strong>初始化容器是在pod的主容器启动之前要运行的容器，主要是做一些主容器的前置工作，它具有两大特征：</strong></p>
<ul>
<li>初始化容器必须运行完成直至结束，若某初始化容器运行失败，那么kubernetes需要重启它直到成功完成</li>
<li>初始化容器必须按照定义的顺序执行，当且仅当前一个成功之后，后面的一个才能运行</li>
</ul>
<p><strong>初始化容器有很多的应用场景，下面列出的是最常见的几个：</strong></p>
<ul>
<li>提供主容器镜像中不具备的工具程序或自定义代码</li>
<li>初始化容器要先于应用容器串行启动并运行完成，因此可用于延后应用容器的启动直至其依赖的条件得到满足</li>
</ul>
<p><strong>创建pod-initcontainer.yaml，内容如下：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-initcontainer</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">        <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">initContainers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-mysql</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;until ping 192.168.132.201 -c 1 ; do echo waiting for mysql..; sleep 2; done;&#x27;</span>]</span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-redis</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox:1.30</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;until ping 192.168.132.202 -c 1; do echo waiting for redis..; sleep 2; done;&#x27;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-initcontainer.yaml </span></span><br><span class="line">pod/pod-initcontainer created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod状态</span></span><br><span class="line"><span class="comment"># 发现pod卡在启动第一个初始化容器过程中，后面的容器不会运行</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-initcontainer -n dev</span></span><br><span class="line">NAME                READY   STATUS     RESTARTS   AGE</span><br><span class="line">pod-initcontainer   0/1     Init:0/2   0          18s</span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl describe pod pod-initcontainer -n dev</span></span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age    From               Message</span><br><span class="line">  ----    ------     ----   ----               -------</span><br><span class="line">  Normal  Scheduled  2m10s  default-scheduler  Successfully assigned dev/pod-initcontainer to node2</span><br><span class="line">  Normal  Pulled     105s   kubelet            Container image <span class="string">&quot;busybox:1.30&quot;</span> already present on machine</span><br><span class="line">  Normal  Created    105s   kubelet            Created container test-mysql</span><br><span class="line">  Normal  Started    105s   kubelet            Started container test-mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态查看pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-initcontainer -n dev -w</span></span><br><span class="line">NAME                READY   STATUS     RESTARTS   AGE</span><br><span class="line">pod-initcontainer   0/1     Init:0/2   0          29s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来新开一个shell,为当前服务器新增两个ip，观察pod的变化</span></span><br><span class="line">ifconfig ens33:1 192.168.132.201 netmask 255.255.255.0 up</span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-initcontainer -n dev -w</span></span><br><span class="line">NAME                READY   STATUS     RESTARTS   AGE</span><br><span class="line">pod-initcontainer   0/1     Init:0/2   0          15s</span><br><span class="line">pod-initcontainer   0/1     Init:1/2   0          39s</span><br><span class="line">pod-initcontainer   0/1     Init:1/2   0          40s</span><br><span class="line"></span><br><span class="line">ifconfig ens33:2 192.168.132.202 netmask 255.255.255.0 up</span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-initcontainer -n dev -w</span></span><br><span class="line">NAME                READY   STATUS     RESTARTS   AGE</span><br><span class="line">pod-initcontainer   0/1     Init:0/2   0          15s</span><br><span class="line">pod-initcontainer   0/1     Init:1/2   0          39s</span><br><span class="line">pod-initcontainer   0/1     Init:1/2   0          40s</span><br><span class="line">pod-initcontainer   0/1     PodInitializing   0          111s</span><br><span class="line">pod-initcontainer   1/1     Running           0          112s</span><br></pre></td></tr></table></figure>

<h3 id="5-3-3-钩子函数"><a href="#5-3-3-钩子函数" class="headerlink" title="5.3.3 钩子函数"></a>5.3.3 钩子函数</h3><p><strong>钩子函数能够感知自身生命周期的事件，并在相应的时刻到来时运行用户指定的程序代码。</strong><br><strong>kubernetes在主容器的启动之后和停止之前提供了两个钩子函数：</strong></p>
<ul>
<li>post start: 容器创建之后执行，如果失败会重启容器</li>
<li>pre stop: 容器终止之前执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作。</li>
</ul>
<p><strong>钩子处理器支持使用下面三种方式定义动作：</strong></p>
<ul>
<li><p>Exec命令： 在容器内执行一次命令</p>
<p>…<br>lifecycle:<br>postStart:<br>exec:<br>command:<br>- cat<br>- &#x2F;tmp&#x2F;healthy<br>…</p>
</li>
<li><p>TCPSocker: 在当前容器尝试访问指定的socket</p>
<p>…<br>lifecyclt:<br>postStart:<br>tcpSocket:<br>port: 8080<br>…</p>
</li>
<li><p>HTTPGet: 在当前容器中向某URL发起http请求</p>
<p>…<br>lifecycle:<br>postStart:<br>httpGet:<br>path: &#x2F; # url地址<br>port: 80 # 端口号<br>host: 192.168.132.140<br>scheme: HTTP # 支持的协议，httph或者https<br>…</p>
</li>
</ul>
<p><strong>接下来，以exec方式为例，演示下钩子函数的使用，创建pod-hook-exec.yaml文件，内容如下：</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-hook-exec</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span> <span class="comment"># 在容器启动的时候执行一个命令，修改掉nginx的默认首页内容</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&#x27;/bin/sh&#x27;</span>,<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;echo postStart... &gt; /usr/share/nginx/html/index.html&#x27;</span>]</span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span> <span class="comment"># 在容器停止之前停止Nginx服务</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&#x27;/usr/sbin/nginx&#x27;</span>,<span class="string">&#x27;-s&#x27;</span>,<span class="string">&#x27;quit&#x27;</span>]        </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-hook-exec.yaml </span></span><br><span class="line">pod/pod-hook-exec created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-hook-exec -n dev -o wide</span></span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-hook-exec   1/1     Running   0          32m   10.244.2.17   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问</span></span><br><span class="line">[root@master ~]<span class="comment"># curl 10.244.2.17:80</span></span><br><span class="line">postStart...</span><br></pre></td></tr></table></figure>

<h3 id="5-3-4-容器探测"><a href="#5-3-4-容器探测" class="headerlink" title="5.3.4 容器探测"></a>5.3.4 容器探测</h3><p>​	容器探测用于检测容器中的应用实例是否正常工作，是保障业务可用性的一种传统机制。如果进过探测，实例的状态不符合预期，那么kubernetes就会把该问题实例“摘除”，不承担业务流量。kubernetes提供了两种探针来实现容器探测，分别是：</p>
<ul>
<li>liveness probes: 存活性探针，用于检测应用实例当前是否处于正常运行状态，如果不是，k8s会重启容器</li>
<li>readiness probes: 就绪性探针，用于检测应用实例当前是否可以接收请求，如果不能，k8s不会转发流量</li>
</ul>
<blockquote>
<p>livenessProbe 决定是否重启容器，readinessProbe决定是否将请求转发给容器。</p>
</blockquote>
<p><strong>上面两种探针目前均支持三种探测方式：</strong></p>
<ul>
<li><p>Exec命令: 在容器内执行一次命令，如果命令执行的退出码为0，则任务程序正常，否则不正常</p>
<p>…<br>livenessProbe:<br>exec:<br>command:<br>- cat<br>- &#x2F;tmp&#x2F;healthy<br>…</p>
</li>
<li><p>TCPSocket: 将会尝试访问一个用户容器的端口，若果能够建立这条连接，则任务程序正常，否则不正常</p>
<p>…<br>livenessProbe:<br>tcpSocket:<br>port: 8080<br>…</p>
</li>
<li><p>HTTPGet: 调用容器内Web应用的URL，如果返回的状态码在200和399之间，则认为程序正常，否则不正常</p>
<p>…<br>livenessProbe:<br>httpGet:<br>path: &#x2F; # URL地址<br>port: 80 # 端口号<br>host: 127.0.0.1 # 主机地址<br>scheme: HTTP # 支持的协议，http或者https<br>…</p>
</li>
</ul>
<p>以liveness probes为例：</p>
<p>**方式一：Exec **</p>
<p>创建pod-liveness-exec.yaml</p>
<pre><code>...
apiVersion: v1
kind: Pod
metadata:
  name: pod-liveness-exec
  namespace: dev
spec:
  containers:
  - name: nginx
    image: nginx:1.17.1
    ports:
    - name: nginx-port
      containerPort: 80
    livenessProbe:
      exec:
        command: [&quot;/bin/cat&quot;,&quot;/tmp/hello.txt&quot;] # 执行一个查看文件的命令
...
</code></pre>
<blockquote>
<p>说明，正常情况下此处的nignx容器里面是没有&#x2F;tmp&#x2F;hello.txt这个文件的，此时容器应该会重启。</p>
</blockquote>
<pre><code># 创建pod
[root@master ~]# kubectl create -f pod-liveness-exec.yaml 
pod/pod-liveness-exec created

# 此时查看pod可以发现状态是running，这又是为何呢？
[root@master ~]# kubectl get pod pod-liveness-exec -n dev
NAME                READY   STATUS    RESTARTS   AGE
pod-liveness-exec   1/1     Running   0          10s

# 再看查看可以看到RESTARTS重启次数增加，状态改变
[root@master ~]# kubectl get pod pod-liveness-exec -n dev
NAME                READY   STATUS             RESTARTS   AGE
pod-liveness-exec   0/1     CrashLoopBackOff   23         58m

[root@master ~]# kubectl describe pod pod-liveness-exec -n dev
Events:
  Type     Reason     Age                    From               Message
  ----     ------     ----                   ----               -------
  Normal   Scheduled  59m                    default-scheduler  Successfully assigned dev/pod-liveness-exec to node1
  Normal   Created    58m (x4 over 59m)      kubelet            Created container nginx
  Normal   Started    58m (x4 over 59m)      kubelet            Started container nginx
  Normal   Killing    58m (x3 over 59m)      kubelet            Container nginx failed liveness probe, will be restarted
  Normal   Pulled     39m (x11 over 59m)     kubelet            Container image &quot;nginx:1.17.1&quot; already present on machine
  Warning  Unhealthy  14m (x58 over 59m)     kubelet            Liveness probe failed: /bin/cat: /tmp/hello.txt: No such file or directory
  Warning  BackOff    4m25s (x218 over 57m)  kubelet            Back-off restarting failed container

# 观察上面的信息发现nginx容器之后就进行了健康检查
# 检查失败之后，容器被kill掉，然后尝试重启（这是重启策略决定）

# 将yaml文件里的参数，修改为一个存在的文件，容器就正常了
</code></pre>
<p>**方法二： TCPSocket **</p>
<p>创建pod-liveness-tcpsocket.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-liveness-tcpsocket</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">tcpSocket:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span>  <span class="comment"># 尝试访问8080端口</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span>    <span class="comment"># 容器启动后多久开始探测</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">2</span>          <span class="comment"># 表示容器必须在2s内做出相应反馈给probe，否则视为探测失败</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">30</span>          <span class="comment"># 探测周期，每30s探测一次</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span>        <span class="comment"># 连续探测1次成功表示成功</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span>        <span class="comment"># 连续探测3次失败表示失败</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-liveness-tcpsocket.yaml </span></span><br><span class="line">pod/pod-liveness-tcpsocket created</span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl describe pod pod-liveness-tcpsocket -n dev</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                From               Message</span><br><span class="line">  ----     ------     ----               ----               -------</span><br><span class="line">  Normal   Scheduled  37s                default-scheduler  Successfully assigned dev/pod-liveness-tcpsocket to node1</span><br><span class="line">  Normal   Pulled     10s (x2 over 37s)  kubelet            Container image <span class="string">&quot;nginx:1.17.1&quot;</span> already present on machine</span><br><span class="line">  Normal   Created    10s (x2 over 37s)  kubelet            Created container nginx</span><br><span class="line">  Normal   Started    10s (x2 over 37s)  kubelet            Started container nginx</span><br><span class="line">  Normal   Killing    10s                kubelet            Container nginx failed liveness probe, will be restarted</span><br><span class="line">  Warning  Unhealthy  0s (x4 over 30s)   kubelet            Liveness probe failed: dial tcp 10.244.1.16:8080: connect: connection refused</span><br></pre></td></tr></table></figure>

<p><strong>方法三：HTTPGet</strong></p>
<p>创建pod-liveness-httpget.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-liveness-httpget</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span> <span class="comment"># 其实就访问http://127.0.0.1:80/hello</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/hello</span></span><br></pre></td></tr></table></figure>

<p>创建pod,观察效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-liveness-httpget.yaml </span></span><br><span class="line">pod/pod-liveness-httpget created</span><br><span class="line">[root@master ~]<span class="comment"># kubectl describe pod pod-liveness-httpget -n dev</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age               From               Message</span><br><span class="line">  ----     ------     ----              ----               -------</span><br><span class="line">  Normal   Scheduled  33s               default-scheduler  Successfully assigned dev/pod-liveness-httpget to node1</span><br><span class="line">  Normal   Pulled     3s (x2 over 32s)  kubelet            Container image <span class="string">&quot;nginx:1.17.1&quot;</span> already present on machine</span><br><span class="line">  Normal   Created    3s (x2 over 32s)  kubelet            Created container nginx</span><br><span class="line">  Normal   Started    3s (x2 over 32s)  kubelet            Started container nginx</span><br><span class="line">  Warning  Unhealthy  3s (x3 over 23s)  kubelet            Liveness probe failed: HTTP probe failed with statuscode: 404</span><br><span class="line">  Normal   Killing    3s                kubelet            Container nginx failed liveness probe, will be restarted</span><br></pre></td></tr></table></figure>

<p><strong>至此，查看livenessProbe的子属性，发现除了以上三种方式，还有一些其他的配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl explain pod.spec.containers.livenessProbe</span></span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line">RESOURCE: livenessProbe &lt;Object&gt;</span><br><span class="line">FIELDS:</span><br><span class="line">   <span class="built_in">exec</span>	&lt;Object&gt;</span><br><span class="line">   httpGet	&lt;Object&gt;</span><br><span class="line">   tcpSocket	&lt;Object&gt;</span><br><span class="line">   </span><br><span class="line">   initialDelaySeconds	&lt;<span class="built_in">integer</span>&gt;   <span class="comment"># 容器启动后等待多少秒执行第一次探测</span></span><br><span class="line"></span><br><span class="line">   timeoutSeconds	&lt;<span class="built_in">integer</span>&gt;       <span class="comment"># 探测超时时间。默认1秒，最小1秒</span></span><br><span class="line"> </span><br><span class="line">   periodSeconds	&lt;<span class="built_in">integer</span>&gt;       <span class="comment"># 执行探测的频率。默认是10秒，最小1秒</span></span><br><span class="line"> </span><br><span class="line">   failureThreshold	&lt;<span class="built_in">integer</span>&gt;       <span class="comment"># 连续探测失败多少次才被认定为失败。默认是3次，最小1次</span></span><br><span class="line"></span><br><span class="line">   successThreshold	&lt;<span class="built_in">integer</span>&gt;       <span class="comment"># 联系探测成功多少次才被认定为成功。默认是1次。</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-5-重启策略"><a href="#5-3-5-重启策略" class="headerlink" title="5.3.5 重启策略"></a>5.3.5 重启策略</h3><p>​		在上一节中，一旦容器探测出现了问题，kubernetes就会对容器所在的pod进行重启，其次这是由pod的重启策略决定的，pod的重启策略有3种，分别如下：</p>
<ul>
<li>Always: 容器失效时，自动重启该容器，这也是默认值。</li>
<li>OnFailure: 容器终止运行且退出码不为0时重启 （异常终止）</li>
<li>Never: 不论状态为何，都不重启该容器</li>
</ul>
<p>  重启策略适用于pod对象中的所有容器，首次需要重启的容器，将在其需要时立即进行重启，随后再次需要重启的操作将由kubelet延迟一段时间后进行，且反复的重启操作的延迟时长以此为10s、20s、40s、80s、160s和300s，300s是最大延迟时长。</p>
<p>创建pod-restartpolicy.yaml:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-restartpolicy</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-port</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/hellp</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span> <span class="comment"># 设置重启策略为Never</span></span><br></pre></td></tr></table></figure>

<ul>
<li>当重启策略为Never是，发现Pod的RESTARTS始终为0</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-restartpolicy.yaml </span></span><br><span class="line">pod/pod-restartpolicy created</span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-restartpolicy -n dev</span></span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-restartpolicy   1/1     Running   0          16s</span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-restartpolicy -n dev</span></span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-restartpolicy   1/1     Running   0          18s</span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-restartpolicy -n dev</span></span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-restartpolicy   1/1     Running   0          19s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>重启策略为Always时，发现RESTARTS重启次数增加。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-restartpolicy -n dev</span></span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-restartpolicy   1/1     Running   0          18s</span><br><span class="line">[root@master ~]<span class="comment"># </span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-restartpolicy -n dev</span></span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-restartpolicy   1/1     Running   5          3m12s</span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl describe pod pod-restartpolicy -n dev</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                     From               Message</span><br><span class="line">  ----     ------     ----                    ----               -------</span><br><span class="line">  Normal   Scheduled  4m30s                   default-scheduler  Successfully assigned dev/pod-restartpolicy to node1</span><br><span class="line">  Normal   Pulled     3m4s (x4 over 4m30s)    kubelet            Container image <span class="string">&quot;nginx:1.17.1&quot;</span> already present on machine</span><br><span class="line">  Normal   Created    3m4s (x4 over 4m30s)    kubelet            Created container nginx</span><br><span class="line">  Normal   Started    3m4s (x4 over 4m30s)    kubelet            Started container nginx</span><br><span class="line">  Normal   Killing    3m4s (x3 over 4m4s)     kubelet            Container nginx failed liveness probe, will be restarted</span><br><span class="line">  Warning  Unhealthy  2m54s (x10 over 4m24s)  kubelet            Liveness probe failed: HTTP probe failed with statuscode: 404</span><br></pre></td></tr></table></figure>

<h2 id="5-4-Pod调度"><a href="#5-4-Pod调度" class="headerlink" title="5.4 Pod调度"></a>5.4 Pod调度</h2><p>在默认情况下，一个pod在那个Node节点上运行，是由Scheduler组件采用相应的算法计算出来的，这个过程是不受人工控制的。但是在实际使用中，这并不满足需求，因为很多情况下，我们想控制某些Pod到达某些节点上，那么应该怎么做呢？这就需要了解kubernetes对Pod的调度规则，kubernetes提供了四大类调度方式：</p>
<ul>
<li>自动调度：运行在哪个节点上完全由Scheduler经过一系列的算法计算得出</li>
<li>定向调度：NodeName、NodeSelector</li>
<li>亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity</li>
<li>污点（容忍）调度：Taints、Toleration</li>
</ul>
<h3 id="5-4-1-定向调度"><a href="#5-4-1-定向调度" class="headerlink" title="5.4.1 定向调度"></a>5.4.1 定向调度</h3><p>定向调度，指的是利用在pod上声明nodeName或者nodeSelector，以此将Pod调度到期望的node节点上。注意，这里的调度是强制的，这就意味着即使要调度的目标Node不存在，也会向上面进行调度，只不过pod运行失败而已。</p>
<h4 id="NodeName"><a href="#NodeName" class="headerlink" title="NodeName"></a>NodeName</h4><p>NodeName用于强制约束将Pod调度到指定的Name的Node节点上。这种方式，其实直接跳过Scheduler的调度逻辑，直接将Pod调度到指定名称的节点。<br>接下来，实验一下：创建一个pod-nodename.yaml文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-nodename</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node1</span> <span class="comment"># 指定调度到node1节点上</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-nodename.yaml </span></span><br><span class="line">pod/pod-nodename created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到此时pod被调度到了node1上面。</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-nodename -n dev -o wide</span></span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-nodename   1/1     Running   0          27s   10.244.1.25   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来，删除pod，修改NodeName的值为node3（并没有node3）</span></span><br><span class="line"><span class="comment"># 发现pod正在被删除</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-nodename -n dev -o wide</span></span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   IP       NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-nodename   0/1     Pending   0          14s   &lt;none&gt;   node3   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h4 id="NodeSelector"><a href="#NodeSelector" class="headerlink" title="NodeSelector"></a>NodeSelector</h4><p>NodeSelector用于将pod调度到添加了指定标签的node节点上。它是通过kubernetes的label-selector机制实现的，也就是说，在pod创建之前，会由scheduler使用MatchNodeSelector调度策略进行label匹配，找出目标node,然后将pod调度到目标节点，该匹配规则是强制约束。<br>接下来，试验一下：</p>
<ol>
<li>首先分别为node节点添加标签</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl label nodes node1 nodeenv=pro</span></span><br><span class="line">node/node1 labeled</span><br><span class="line">[root@master ~]<span class="comment"># kubectl label nodes node2 nodeenv=test</span></span><br><span class="line">node/node2 labeled</span><br><span class="line">[root@master ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<ol>
<li>创建一个pod-nodeselector.yaml文件，并使用它 创建pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-nodeselector</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ningx:1.17.1</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">nodeenv:</span> <span class="string">pro</span> <span class="comment"># 指定调度到具有nodeenv=pro标签的节点上</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-nodeselector.yaml </span></span><br><span class="line">pod/pod-nodeselector created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到pod被调度到了node1上面了</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-nodeselector -n dev -o wide</span></span><br><span class="line">NAME               READY   STATUS              RESTARTS   AGE   IP       NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-nodeselector   1/1     Running             0          19s   &lt;none&gt;   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来，删除pod,修改NodeSelector的值为nodeenv：xxx(不存在拥有此标签的节点)</span></span><br><span class="line"><span class="comment"># 发现pod无法运行，node值为none</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl  get pod pod-nodeselector -n dev -o wide</span></span><br><span class="line">NAME               READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-nodeselector   0/1     Pending   0          25s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看详情发现node selector匹配失败的提示</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl  describe pod pod-nodeselector -n dev</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age   From               Message</span><br><span class="line">  ----     ------            ----  ----               -------</span><br><span class="line">  Warning  FailedScheduling  74s   default-scheduler  0/3 nodes are available: 1 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn<span class="string">&#x27;t tolerate, 2 node(s) didn&#x27;</span>t match Pod<span class="string">&#x27;s node affinity.</span></span><br><span class="line"><span class="string">  Warning  FailedScheduling  74s   default-scheduler  0/3 nodes are available: 1 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn&#x27;</span>t tolerate, 2 node(s) didn<span class="string">&#x27;t match Pod&#x27;</span>s node affinity.</span><br></pre></td></tr></table></figure>

<h3 id="5-4-2亲和性调度"><a href="#5-4-2亲和性调度" class="headerlink" title="5.4.2亲和性调度"></a>5.4.2亲和性调度</h3><p>上一节，介绍了两种定向调度的方式，使用起来非常方便，但是也有点一定的问题，那就是如果没有满足条件的Node，那么Pod将不会被运行，即使再集群中还有可用的Node也不行，这就限制了它的使用场景。</p>
<p>基于上面的问题，kubernetes还提供了一种亲和性调度（Affinity）。它在NodeSelector的基础之上进行了扩展，可以通过配置的形式，实现优先选择满足条件的Node进行调度，如果没有，也可以调度到不满足条件的节点上，使用度更加灵活。</p>
<p><strong>Affinity主要分为三类</strong></p>
<ul>
<li>nodeAffinity(node亲和性)：以node为目标，解决pod可以调度到哪些node的问题</li>
<li>podAffinity(pod亲和性)：以pod为目标，解决pod可以和哪些已存在的pod部署在同一个拓扑域中的问题</li>
<li>podAntiAffinity(pod反亲和性)：以pod为目标，解决pod不能和哪些已存在的pod部署在同一个拓扑域中的问题</li>
</ul>
<blockquote>
<p>关于亲和性（反亲和性）使用场景说明：</p>
</blockquote>
<ul>
<li>亲和性：如果两个应用频繁交互，那就有必要利用亲和性让两个应用尽可能的靠近，这样可以减少因网络通信而带来的性能损耗。</li>
<li>反亲和性：当应用采用多副本部署时，有必要采用反亲和性让各个应用实例打散分别在各个node上，这样可以提高服务的高可用性。</li>
</ul>
<p><strong>NodeAffinity（Node亲和性）</strong></p>
<p>首先来看一下NideAffinity的可配置项：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pod.spec.affinity.nodeAffinity</span></span><br><span class="line">  <span class="string">requiredDuringSchedulingIgnoredDuringExecution</span>  <span class="comment"># Node节点必须满足指定的所有规则才可以，相当于硬限制</span></span><br><span class="line">    <span class="string">nodeSelectorTerms</span>   <span class="comment"># 节点选择列表</span></span><br><span class="line">      <span class="string">matchFields</span>   <span class="comment"># 按节点字段列出的节点选择器要求列表</span></span><br><span class="line">      <span class="string">matchExpressions</span>  <span class="comment"># 按节点标签列出的节点选择器要求列表（推荐）</span></span><br><span class="line">        <span class="string">key</span>     <span class="comment"># 键</span></span><br><span class="line">        <span class="string">values</span>  <span class="comment"># 值</span></span><br><span class="line">        <span class="string">operator</span>    <span class="comment"># 关系符  支持Exists, DoesNotExist; In,NotIn; Gt,Lt</span></span><br><span class="line">  <span class="string">preferredDuringSchedulingIgnoredDuringExecution</span>  <span class="comment"># 优先调度到满足指定的规则的Node，相当于软限制（倾向）</span></span><br><span class="line">    <span class="string">preference</span>   <span class="comment"># 一个几点选择器项，与相应的权重相关联</span></span><br><span class="line">      <span class="string">matchFields</span>  <span class="comment"># 按节点字段列出的节点选择器要求列表</span></span><br><span class="line">      <span class="string">matchExpressions</span>   <span class="comment"># 按节点标签列出的节点选择器要求列表（推荐）</span></span><br><span class="line">        <span class="string">key</span>     <span class="comment"># 键</span></span><br><span class="line">        <span class="string">values</span>  <span class="comment"># 值</span></span><br><span class="line">        <span class="string">operator</span>    <span class="comment"># 关系符  支持Exists, DoesNotExist; In,NotIn; Gt,Lt</span></span><br><span class="line">      <span class="string">weight</span>   <span class="comment"># 倾向权重，在范围1-100</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关系符的使用说明：</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodeenv</span>        <span class="comment"># 匹配存在标签的key为nodeenv的节点</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodeenv</span>        <span class="comment"># 匹配标签的key为nodeenv，且value是&quot;xxx&quot;或&quot;yyy&quot;的节点</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">    <span class="attr">values:</span> [<span class="string">&quot;xxx&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodeenv</span>        <span class="comment"># 匹配标签的key为nodeenv，且value大于&quot;xxx&quot;的节点</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Gt</span></span><br><span class="line">    <span class="attr">values:</span> <span class="string">&quot;xxx&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>1、接下来首先演示一下requiredDuringSchedulingIgnoredDuringExecution<br>创建pod-nodeaffinity-required.yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-nodeaffinity-required</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">affinity:</span>     <span class="comment"># 亲和性设置</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span>  <span class="comment"># 设置node亲和性</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment"># 硬限制</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span>   <span class="comment"># 匹配env的值在values中的标签</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodeenv</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span> [<span class="string">&quot;xxx&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前节点拥有的标签</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get nodes --show-labels </span></span><br><span class="line">NAME     STATUS   ROLES                  AGE    VERSION   LABELS</span><br><span class="line">master   Ready    control-plane,master   220d   v1.20.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=</span><br><span class="line">node1    Ready    &lt;none&gt;                 220d   v1.20.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node1,kubernetes.io/os=linux,nodeenv=pro</span><br><span class="line">node2    Ready    &lt;none&gt;                 220d   v1.20.0   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=node2,kubernetes.io/os=linux,nodeenv=<span class="built_in">test</span></span><br><span class="line"><span class="comment">#### 可以发现此时集群节点中并没有满足拥有yaml文件中的xxx、yyy标签的节点</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-nodeaffinity-required.yaml </span></span><br><span class="line">pod/pod-nodeaffinity-required created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常看状态(运行失败)</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-nodeaffinity-required -n dev -o wide</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-nodeaffinity-required   0/1     Pending   0          25s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="comment"># kubectl describe pod pod-nodeaffinity-required -n dev</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age    From               Message</span><br><span class="line">  ----     ------            ----   ----               -------</span><br><span class="line">  Warning  FailedScheduling  3m30s  default-scheduler  0/3 nodes are available: 1 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn<span class="string">&#x27;t tolerate, 2 node(s) didn&#x27;</span>t match Pod<span class="string">&#x27;s node affinity.</span></span><br><span class="line"><span class="string">  Warning  FailedScheduling  3m30s  default-scheduler  0/3 nodes are available: 1 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn&#x27;</span>t tolerate, 2 node(s) didn<span class="string">&#x27;t match Pod&#x27;</span>s node affinity.</span><br></pre></td></tr></table></figure>

<p>接下来，我们修改yaml文件中亲和性标签为pro（node1节点拥有的标签）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-nodeaffinity-required.yaml </span></span><br><span class="line">pod/pod-nodeaffinity-required created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发现pod已经被分配到node1上并且运行成功。</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod-nodeaffinity-required -n dev -o wide</span></span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-nodeaffinity-required   1/1     Running   0          29s   10.244.1.29   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li>2、其次演示一下软限制preferredDuringSchedulingIgnoredDuringExecution<br>创建pod-nodeaffinity-preferred.yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-nodeaffinity-preferred</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">affinity:</span>     <span class="comment"># 亲和性设置</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span>  <span class="comment"># 设置node亲和性</span></span><br><span class="line">      <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment"># 软限制</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">        <span class="string">preference</span></span><br><span class="line">          <span class="attr">matchExpressions:</span>   <span class="comment"># 匹配env的值在values中的标签</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nodeenv</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span> [<span class="string">&quot;xxx&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#　创建pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-nodeaffinity-preferred.yaml </span></span><br><span class="line">pod/pod-nodeaffinity-preferred created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到即使没有满足标签条件的节点，pod也正常启动成功，并且分配到了node2中。</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod -n dev pod-nodeaffinity-preferred -o wide</span></span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-nodeaffinity-preferred   1/1     Running   0          38s   10.244.2.22   node2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>NodeAffinity规则设置的注意事项：</strong></p>
</blockquote>
<ol>
<li>如果同时定义了nodeSelector和nodeAffinity，那么必须两个条件都满足，pod才能够运行在指定的node上。</li>
<li>如果nodeAffinity指定了多个nodeSelectorTerms，那么只需要其中一个能够匹配成功即可</li>
<li>如果一个nodeSelectorTerms中有多个matchExpressions，则一个节点必须满足所有的才能匹配成功</li>
<li>如果一个pod所在的Node在Pod运行期间其标签发送了改变，不再符合该Pod的节点亲和性需求，则系统将忽略次变化。</li>
</ol>
<p><strong>PodAffinity（Pod亲和性）</strong><br>PodAffinity主要实现以运行的Pod为参照，实现让新创建的Pod跟参照Pod在同一个区域的功能。<br>首先来看一下PodAffinity的可配置项：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pod.spec.affinity.podAffinity</span></span><br><span class="line">  <span class="string">requiredDuringSchedulingIgnoredDuringExecution</span>  <span class="comment"># 硬限制</span></span><br><span class="line">    <span class="string">namespaces</span>      <span class="comment"># 制定参照Pod的namespace</span></span><br><span class="line">    <span class="string">topologyKey</span>     <span class="comment"># 指定调度作用域</span></span><br><span class="line">    <span class="string">labelSelector</span>   <span class="comment"># 标签选择器</span></span><br><span class="line">      <span class="string">matchExpressions</span>  <span class="comment"># 按节点标签列出的节点选择器要求列表(推荐)</span></span><br><span class="line">        <span class="string">key</span>   <span class="comment"># 键</span></span><br><span class="line">        <span class="string">values</span> <span class="comment"># 值</span></span><br><span class="line">        <span class="string">operator</span>  <span class="comment"># 关系符 支持In,NotIng; Exists, DoesNotExist.</span></span><br><span class="line">      <span class="string">matchLables</span>   <span class="comment"># 指多个matchExpressions映射的内容</span></span><br><span class="line">    </span><br><span class="line">  <span class="string">preferredDuringSchedulingIgnoredDuringExecution</span>  <span class="comment"># 软限制</span></span><br><span class="line">    <span class="string">podAffinityTerm</span>     <span class="comment"># 选项</span></span><br><span class="line">      <span class="string">namespaces</span></span><br><span class="line">      <span class="string">topologyKey</span></span><br><span class="line">      <span class="string">labelSelector</span></span><br><span class="line">        <span class="string">matchExpressions</span></span><br><span class="line">          <span class="string">key</span>   <span class="comment"># 键</span></span><br><span class="line">          <span class="string">values</span> <span class="comment"># 值</span></span><br><span class="line">          <span class="string">operator</span>  <span class="comment"># 关系符 支持In,NotIng; Exists, DoesNotExist.</span></span><br><span class="line">        <span class="string">matchLables</span>   <span class="comment"># 指多个matchExpressions映射的内容</span></span><br><span class="line">      <span class="string">weight</span>    <span class="comment"># 倾向权重，范围1-100</span></span><br></pre></td></tr></table></figure>

<pre><code>topologyKey 用于指定调度是作用域，例如：
    如果指定为kubernetes.io/hostname,那就是以Node节点为区分范围
    如果指定为beta.kubernetes.io/os,则以Node节点的操作系统类型来区分
</code></pre>
<p>接下来，以硬限制requiredDuringSchedulingIgnoredDuringExecution为例：</p>
<ul>
<li>1、首先创建一个参照pod，pod-podaffinity-target.yaml;</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-podaffinity-target</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">podenv:</span> <span class="string">pro</span>     <span class="comment"># 设置标签</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node1</span>  <span class="comment"># 将目标pod名确指定到node1上</span></span><br></pre></td></tr></table></figure>

<pre><code>[root@master ~]# kubectl create -f pod-podaffinity-target.yaml 
pod/pod-podaffinity-target created
[root@master ~]# kubectl get pod -n dev pod-podaffinity-target -o wide
NAME                     READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED NODE   READINESS GATES
pod-podaffinity-target   1/1     Running   0          21s   10.244.1.30   node1   &lt;none&gt;           &lt;none&gt;
</code></pre>
<ul>
<li>2、创建pod-podaffinity-required.yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-podaffinity-required</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">affinity:</span>  <span class="comment"># 亲和性设置</span></span><br><span class="line">    <span class="attr">podAffinity:</span> <span class="comment"># 设置Pod亲和性</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span>  <span class="comment"># 硬限制</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span>  <span class="comment"># 匹配env的值在[&quot;xxx&quot;,&quot;yyy&quot;]中的标签</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">podenv</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span> [<span class="string">&quot;xxx&quot;</span>,<span class="string">&quot;yyy&quot;</span>]</span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure>

<p>上面配置表达的意思是：新Pod必须要与拥有标签nodeenv&#x3D;xxx或者nodeenv&#x3D;yyy的pod在同一Node上，显然现在没有这样的Pod，运行测试一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-podaffinity-required.yaml </span></span><br><span class="line">pod/pod-podaffinity-required created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod运行状态</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod -n dev pod-podaffinity-required -o wide</span></span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-podaffinity-required   0/1     Pending   0          18s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># pod详细描述</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl describe pod pod-podaffinity-required -n dev</span></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age   From               Message</span><br><span class="line">  ----     ------            ----  ----               -------</span><br><span class="line">  Warning  FailedScheduling  69s   default-scheduler  0/3 nodes are available: 1 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn<span class="string">&#x27;t tolerate, 2 node(s) didn&#x27;</span>t match pod affinity rules, 2 node(s) didn<span class="string">&#x27;t match pod affinity/anti-affinity.</span></span><br><span class="line"><span class="string">  Warning  FailedScheduling  69s   default-scheduler  0/3 nodes are available: 1 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn&#x27;</span>t tolerate, 2 node(s) didn<span class="string">&#x27;t match pod affinity rules, 2 node(s) didn&#x27;</span>t match pod affinity/anti-affinity.</span><br><span class="line"><span class="comment"># 3个节点存活，其中一个节点(master)有污点，不能够被调度，其他两个节点不匹配pod亲和性/反亲和性规则</span></span><br></pre></td></tr></table></figure>

<p>修改yaml文件values: [“pro”,”yyy”]，再次验证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-podaffinity-required.yaml </span></span><br><span class="line">pod/pod-podaffinity-required created</span><br><span class="line"></span><br><span class="line"><span class="comment">#　可以看到pod被分配到了node1,运行成功</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod -n dev pod-podaffinity-required -o wide</span></span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-podaffinity-required   1/1     Running   0          34s   10.244.1.31   node1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p><strong>PodAntiAffinity（Pod反亲和性）</strong><br>PodAntiAffinity主要实现以运行的Pod为参照，让新创建的Pod跟参照Pod不在一个区域的功能。<br>他的配置方法和选项与PodAffinity是一样的。案例：</p>
<ul>
<li><p>1、创建参照Pod（继续使用上述案例中的）</p>
<p>[root@master ~]# kubectl get pod -n dev –show-labels<br>NAME                         READY   STATUS    RESTARTS   AGE    LABELS<br>pod-nodeaffinity-preferred   1&#x2F;1     Running   0          117m   &lt;none&gt;<br>pod-nodeaffinity-required    1&#x2F;1     Running   0          137m   &lt;none&gt;<br>pod-podaffinity-required     1&#x2F;1     Running   0          11m    &lt;none&gt;<br>pod-podaffinity-target       1&#x2F;1     Running   0          45m    podenv&#x3D;pro</p>
</li>
<li><p>2、创建pod-podantiaffinity-required.yaml</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-podantiaffinity-required</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAntiAffinity:</span> <span class="comment"># 设置Pod亲和性为反pod亲和性</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span>  <span class="comment"># 硬限制</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span>  <span class="comment"># 匹配env的值在[&quot;pro&quot;]中的标签</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">podenv</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span> [<span class="string">&quot;pro&quot;</span>]</span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br></pre></td></tr></table></figure>

<p>上面配置表达的意思是：新Pod必须要与拥有标签nodeenv&#x3D;pro的pod不在同一个Node上，运行测试。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建pod</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-podantiaffinity-required.yaml </span></span><br><span class="line">pod/pod-podantiaffinity-required created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod发现，pod被分配到了node2节点上</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod -n dev pod-podantiaffinity-required -o wide</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-podantiaffinity-required   1/1     Running   0          34s   10.244.2.23   node2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="5-4-3-污点和容忍"><a href="#5-4-3-污点和容忍" class="headerlink" title="5.4.3 污点和容忍"></a>5.4.3 污点和容忍</h3><h4 id="污点（Taints）"><a href="#污点（Taints）" class="headerlink" title="污点（Taints）"></a>污点（Taints）</h4><p>前面的调度方式都是站在Pod的角度上，通过在Pod上添加属性，来确定Pod是否要调度到指定的Node上，其实我们也可以站在Node的角度上，通过在Node上添加污点属性，来决定是否允许Pod调度过来。</p>
<p>Node被设置上污点之后就和Pod之间存在了一种相斥的关系，进而拒绝Pod调度进来，甚至可以将已经存在的Pod被驱逐出去。</p>
<p>污点的格式为：key&#x3D;value:effect，key和value是污点的标签，effect描述污点的作用，支持如下三个选项：</p>
<ul>
<li>PreferNoSchedule:Kuernetes将尽量避免把Pod调度到具有污点的Node上，除非没有其他节点可调度</li>
<li>NoSchedule:kubernetes将不会把Pod调度到具有该污点的Node上，但不会影响当前Node上已存在的Pod</li>
<li>NoExecute:kubernetes将不会把Pod调度到具有该污点的Node上，同时也会将Node上已存在的Pod驱离<br><img src="https://note.youdao.com/yws/res/44219/A4304AB9910D480BACE6C74A86544462" alt="image"></li>
</ul>
<p>使用kubernetes设置和去除污点的命令：</p>
<pre><code># 设置污点
kubectl taint nodes node1 key=value:effect

# 去除污点
kubectl taint nodes node1 key:effect-

# 去除所有污点
kubectl taint nodes node1 key-
</code></pre>
<p><strong>案例演示</strong></p>
<ul>
<li><ol>
<li>准备节点node1(为了演示，暂时停掉node2)</li>
</ol>
</li>
<li><ol>
<li>为node1节点设置一个污点：tag&#x3D;yali:PreferNoSchedule;然后创建pod1（启动成功）</li>
</ol>
</li>
<li><ol>
<li>修改node1节点污点为: tag&#x3D;yali:NoScheduler；然后创建pod2（pod1还在，pod2启动失败）</li>
</ol>
</li>
<li><ol>
<li>修改node1节点污点为：tag&#x3D;yali:NoExecute; 创建pod3 (3个pod都失败)</li>
</ol>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当前集群信息</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME     STATUS     ROLES                  AGE    VERSION</span><br><span class="line">master   Ready      control-plane,master   221d   v1.20.0</span><br><span class="line">node1    Ready      &lt;none&gt;                 221d   v1.20.0</span><br><span class="line">node2    NotReady   &lt;none&gt;                 221d   v1.20.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为node1设置污点(PreferNoSchedule)</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl taint nodes node1 tag=yali:PreferNoSchedule</span></span><br><span class="line">node/node1 tainted</span><br><span class="line">[root@master ~]<span class="comment"># kubectl describe nodes node1</span></span><br><span class="line">Name:               node1</span><br><span class="line">Roles:              &lt;none&gt;</span><br><span class="line">Labels:             beta.kubernetes.io/arch=amd64</span><br><span class="line">                    beta.kubernetes.io/os=linux</span><br><span class="line">                    kubernetes.io/arch=amd64</span><br><span class="line">                    kubernetes.io/hostname=node1</span><br><span class="line">                    kubernetes.io/os=linux</span><br><span class="line">                    nodeenv=pro</span><br><span class="line">Annotations:        flannel.alpha.coreos.com/backend-data: &#123;<span class="string">&quot;VNI&quot;</span>:1,<span class="string">&quot;VtepMAC&quot;</span>:<span class="string">&quot;c2:31:6d:c9:69:bc&quot;</span>&#125;</span><br><span class="line">                    flannel.alpha.coreos.com/backend-type: vxlan</span><br><span class="line">                    flannel.alpha.coreos.com/kube-subnet-manager: <span class="literal">true</span></span><br><span class="line">                    flannel.alpha.coreos.com/public-ip: 192.168.132.141</span><br><span class="line">                    kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock</span><br><span class="line">                    node.alpha.kubernetes.io/ttl: 0</span><br><span class="line">                    volumes.kubernetes.io/controller-managed-attach-detach: <span class="literal">true</span></span><br><span class="line">CreationTimestamp:  Thu, 17 Jun 2021 22:22:49 +0800</span><br><span class="line">Taints:             tag=yali:PreferNoSchedule           <span class="comment"># 设置的污点</span></span><br><span class="line">Unschedulable:      <span class="literal">false</span></span><br><span class="line">Lease:</span><br><span class="line">  HolderIdentity:  node1</span><br><span class="line">  AcquireTime:     &lt;<span class="built_in">unset</span>&gt;</span><br><span class="line">  RenewTime:       Tue, 25 Jan 2022 13:30:28 +0800</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建pod1</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl run pod1 --image=nginx:1.17.1</span></span><br><span class="line">pod/pod1 created</span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pod pod1 -o wide</span></span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod1   1/1     Running   0          60s   10.244.1.32   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为node1取消PreferNoScheduler，设置NoSchedule</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl taint nodes node1 tag:PreferNoSchedule-</span></span><br><span class="line">node/node1 untainted</span><br><span class="line">[root@master ~]<span class="comment"># kubectl taint nodes node1 tag=yali:NoSchedule</span></span><br><span class="line">node/node1 tainted</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建pod2</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl run pod2 --image=nginx:1.17.1</span></span><br><span class="line">pod/pod2 created</span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pods  -o wide</span></span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE     IP            NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">pod1          1/1     Running   0          5m20s   10.244.1.32   node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod2          0/1     Pending   0          11s     &lt;none&gt;        &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为node1取消NoSchedule，设置NoExecute</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl taint nodes node1 tag:NoSchedule-</span></span><br><span class="line">node/node1 untainted</span><br><span class="line">[root@master ~]<span class="comment"># kubectl taint nodes node1 tag=yali:NoExecute</span></span><br><span class="line">node/node1 tainted</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建pod3</span></span><br><span class="line">[root@master ~]<span class="comment"># kubectl run pod3 --image=nginx:1.17.1</span></span><br><span class="line">pod/pod3 created</span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pods  -o wide</span></span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">pod1          0/1     Pending   0          29s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod2          0/1     Pending   0          29s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod3          0/1     Pending   0          6s    &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>提示：使用kubeadm搭建的集群，默认就会给master节点添加一个污点标记，所以pod不会被调度到master节点上。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl describe nodes master</span></span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br></pre></td></tr></table></figure>

<h4 id="容忍-Toleration"><a href="#容忍-Toleration" class="headerlink" title="容忍(Toleration)"></a>容忍(Toleration)</h4><p>上面介绍了污点的作用，可以在node上添加污点用于拒绝pod调度上了，但是如果就是想将一个pod调度到一个有污点的node上去，这时候就要使用容忍了。</p>
<p><img src="https://note.youdao.com/yws/res/44220/D937F758F79E433B916870703F7EAFE4" alt="image"></p>
<blockquote>
<p>污点就是拒绝，容忍就是忽略，Node通过污点拒绝pod调度上去，Pod通过容忍忽略拒绝</p>
</blockquote>
<p>案例：</p>
<ol>
<li>上一节中，已经在node1节点上打上了NoExecute的污点，此时pod是调度不上去的</li>
<li>本小节，可以通过给pod添加容忍，然后将其调度上去</li>
</ol>
<p>创建pod-toleration.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-toleration</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">dev</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">  <span class="attr">tolerations:</span>		<span class="comment"># 添加容忍</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;tag&quot;</span>		<span class="comment"># 要容忍的污点的key</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span>  <span class="comment"># 操作符这里表示=</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;yali&quot;</span>	<span class="comment"># 要容忍的污点的value</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoExecute&quot;</span>  <span class="comment"># 添加容忍的规则，这里必须和标记的污点规则相同</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># kubectl create -f pod-toleration.yaml </span></span><br><span class="line">pod/pod-toleration created</span><br><span class="line">[root@master ~]<span class="comment"># kubectl get pods -n dev -o wide</span></span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP            NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-toleration   1/1     Running   0          18s   10.244.1.39   node1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>容忍的详细配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master~]<span class="comment"># kubectl explain pod.spec.tolerations</span></span><br><span class="line">......</span><br><span class="line">FIELDS:</span><br><span class="line">	key			<span class="comment"># 对应着要容忍的污点的键，空意味着匹配所有的键</span></span><br><span class="line">	value		<span class="comment"># 对应着要容忍的污点的值</span></span><br><span class="line">	operator	<span class="comment"># key-value的运算符，支持Equal和Exists(默认)</span></span><br><span class="line">	effect		<span class="comment"># 对应污点的effect，空意味着匹配所有影响</span></span><br><span class="line">	tolerationSeconds	<span class="comment"># 容忍时间，当effect为NoExecute时生效，表示pod在Node上的停留时间</span></span><br></pre></td></tr></table></figure>



  </article>
  <!-- tag -->
  <div class="mt-12 pt-6 border-t border-gray-200">
    
      
        <span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 m-1 text-sm rounded-md transition-colors hover:bg-gray-200">
          <a href="/tags/docker/">docker</a>
        </span>
      
        <span class="bg-gray-100 dark:bg-gray-700 px-2 py-1 m-1 text-sm rounded-md transition-colors hover:bg-gray-200">
          <a href="/tags/kubernetes/">kubernetes</a>
        </span>
      
    
  </div>
  <!-- prev and next -->
  <div class="flex justify-between mt-12 pt-6 border-t border-gray-200">
    <div>
      
    </div>
    <div>
      
        <a href="/2023/10/24/hello-world/" class="text-sm text-gray-400 hover:text-gray-500 flex justify-center">
          Hello World
          <iconify-icon width="20" icon="ri:arrow-right-s-line" data-inline="false"></iconify-icon>
        </a>
      
    </div>
  </div>
  <!-- comment -->
  <div class="article-comments mt-12">
    

  </div>
</section>
<!-- js inspect -->

<script src="/lib/clipboard.min.js"></script>


<script async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
  });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
  $(document).ready(() => {
    const maraidConfig = {
      theme: "default",
      logLevel: 3,
      flowchart: { curve: "linear" },
      gantt: { axisFormat: "%m/%d/%Y" },
      sequence: { actorMargin: 50 },
    };
    mermaid.initialize(maraidConfig);
  });
</script>



<script src="/lib/fancybox/fancybox.umd.min.js"></script>

<script>
  $(document).ready(() => {
    $('.post-content').each(function(i){
      $(this).find('img').each(function(){
        if ($(this).parent().hasClass('fancybox') || $(this).parent().is('a')) return;
        var alt = this.alt;
        if (alt) $(this).after('<span class="fancybox-alt">' + alt + '</span>');
        $(this).wrap('<a class="fancybox-img" href="' + this.src + '" data-fancybox=\"gallery\" data-caption="' + alt + '"></a>')
      });
      $(this).find('.fancybox').each(function(){
        $(this).attr('rel', 'article' + i);
      });
    });

    Fancybox.bind('[data-fancybox="gallery"]', {
        // options
    })
  })
</script>

<!-- tocbot begin -->

<script src="/lib/tocbot/tocbot.min.js"></script>

<script>
  $(document).ready(() => {
      tocbot.init({
        // Where to render the table of contents.
        tocSelector: '.post-toc',
        // Where to grab the headings to build the table of contents.
        contentSelector: '.post-content',
        // Which headings to grab inside of the contentSelector element.
        headingSelector: 'h1, h2, h3',
        // For headings inside relative or absolute positioned containers within content.
        hasInnerContainers: true,
    });
  })
</script>
<!-- tocbot end -->


  </main>
  <footer class="flex flex-col h-40 items-center justify-center text-gray-400 text-sm">
  <div class="flex items-center gap-2">
    <span>© 2023</span>
    <iconify-icon width="18" icon="emojione-monotone:maple-leaf" ></iconify-icon>
    <a href="https://github.com/Yali7" target="_blank" rel="noopener noreferrer">Yali.Wang</a>
  </div>
  <!-- busuanzi -->
  
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- Busuanzi Analytics -->
<div class="flex items-center gap-2">
  <span>Visitors</span>
  <span id="busuanzi_value_site_uv"></span>
  <span>Page Views</span>
  <span id="busuanzi_value_site_pv"></span>
</div>
<!-- End Busuanzi Analytics -->


  <!-- copyright -->
</footer>

  <div class="back-to-top box-border fixed right-6 z-1024 -bottom-20 rounded py-1 px-1 bg-slate-900 opacity-60 text-white cursor-pointer text-center dark:bg-slate-600">
    <span class="flex justify-center items-center text-sm">
      <iconify-icon width="18" icon="ion:arrow-up-c" id="go-top"></iconify-icon>
      <span id="scrollpercent"><span>0</span> %</span>
    </span>
  </div>
  
<script src="/js/main.js"></script>


  <script>
    $(document).ready(function () {
      const mapleCount = "10";
      const speed = "0.5";
      const mapleEl = document.getElementById("maple");
      const maples = Array.from({ length: mapleCount }).map(() => {
        const maple = document.createElement("div");
        const scale = Math.random() * 0.5 + 0.5;
        const offset = Math.random() * 2 - 1;
        const x = Math.random() * mapleEl.clientWidth;
        const y = -Math.random() * mapleEl.clientHeight;
        const duration = 10 / speed;
        const delay = -duration;
        maple.className = "maple";
        maple.style.width = `${24 * scale}px`;
        maple.style.height = `${24 * scale}px`;
        maple.style.left = `${x}px`;
        maple.style.top = `${y}px`;
        maple.style.setProperty("--maple-fall-offset", offset);
        maple.style.setProperty("--maple-fall-height", `${Math.abs(y) + mapleEl.clientHeight}px`);
        maple.style.animation = `fall ${duration}s linear infinite`;
        maple.style.animationDelay = `${delay}s`;
        mapleEl.appendChild(maple)
        return maple
      })
    });
  </script>
  


  <div class="fixed top-0 bottom-0 left-0 right-0 pointer-events-none print:hidden" id="maple"></div>
</body>

</html>
